     1                                  ;---------------------
     2                                  ; - Configration Start to Boot Program Address.
     3                                  ;---------------------
     4                                  BOOT_LOAD equ 0x7c00    ; load to start boot program address.
     5                                  ORG       BOOT_LOAD     ; instruction load address to assembler.
     6                                  
     7                                  ;---------------------
     8                                  ; - Declaration Macro.
     9                                  ;---------------------
    10                                  %include "../include/macro.asm"
     1                              <1> %macro cdecl 1-*.nolist
     2                              <1> 
     3                              <1>     %rep %0 - 1
     4                              <1>         push %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1>     %rotate -1
     8                              <1> 
     9                              <1>         call %1
    10                              <1> 
    11                              <1>     %if 1 < %0
    12                              <1>         add sp, (__BITS__ >> 3) * (%0-1)
    13                              <1>     %endif
    14                              <1> 
    15                              <1> %endmacro
    11                                  
    12                                  entry:
    13                                      ;---------------------
    14                                      ; - BPB(BIOS Parameter Block).
    15                                      ; - First calling to ipl label.
    16                                      ; - BIOS Needs Information.
    17                                      ; - 0x90 set to 90bytes.
    18                                      ; - NOP(do no something).
    19                                      ;---------------------
    20 00000000 EB58                        jmp   ipl
    21 00000002 90<rept>                    times 90 - ($ - $$) db 0x90
    22                                  
    23                                  ipl:
    24 0000005A FA                          cli                 ; disable interrupt.
    25                                  
    26                                      ;------------------
    27                                      ; - Configuration Segment Register.
    28                                      ; - Segment is separate memory blocks.
    29                                      ; - Initialize Register.
    30                                      ;-------------------
    31 0000005B B80000                      mov ax, 0x0000      ; AX = 0x0000;
    32                                  
    33 0000005E 8ED8                        mov ds, ax          ; DS = 0x0000;
    34 00000060 8EC0                        mov es, ax          ; ES = 0x0000;
    35 00000062 8ED0                        mov ss, ax          ; SS = 0x0000;
    36                                  
    37                                      ;---------------------
    38                                      ; - Stack the boot program start position on the stack pointer.
    39                                      ;---------------------
    40 00000064 BC007C                      mov sp, BOOT_LOAD    ; SP = 0x7c00;
    41                                  
    42 00000067 FB                          sti                 ; enable interrupt.
    43                                  
    44                                      ;---------------------
    45                                      ; - Saving Boot Drive.
    46                                      ; - dl register is I/O register.
    47                                      ;---------------------
    48 00000068 8816[B800]                  mov [BOOT.DRIVE], dl
    49                                  
    50                                      ;--------------------
    51                                      ; - Call putc function, argument is '.s0'.
    52                                      ; - Call reboot function, nothing argument.
    53                                      ;--------------------
    54 0000006C 68[9800]E8480083C4-         cdecl putc, .s0
    54 00000074 02                 
    55                                  
    56                                      ;--------------------
    57                                      ; - Reading Next 512 bytes.
    58                                      ; - CHS
    59                                      ;--------------------
    60 00000075 B402                        mov ah, 0x02                ; 0x02 is reading order.
    61 00000077 B001                        mov al, 1                   ; al = Reading sector number.
    62 00000079 B90200                      mov cx, 0x0002              ; cx = Cylinder / Sector
    63 0000007C B600                        mov dh, 0x00                ; dh = Head position.
    64 0000007E 8A16[B800]                  mov dl, [BOOT.DRIVE]        ; dl = Drive Number.
    65 00000082 BB007E                      mov bx, 0x7C00 + 512        ; BX = Offset.
    66 00000085 CD13                        int 0x13                    ; 0x13 is BIOS Call.
    67 00000087 730C                    .10Q: jnc .10E                  ; (0x13 == 0x02(ah??))
    68 00000089 68[A500]E82B0083C4-     .10T: cdecl putc, .e0           ; start failure.
    68 00000091 02                 
    69 00000092 E84400                      call reboot
    70                                  .10E:                           ; start succeded.
    71 00000095 E96801                      jmp stage_2
    72                                  
    73                                  ;--------------------
    74                                  ; - 0x0A is LF(Line Feed).
    75                                  ; - 0x0D is CR(Caridge Return).
    76                                  ;--------------------
    77 00000098 426F6F74696E672E2E-     .s0 db "Booting...", 0x0A, 0x0D, 0
    77 000000A1 2E0A0D00           
    78 000000A5 4572726F7220736563-     .e0 db "Error sector read.", 0
    78 000000AE 746F7220726561642E-
    78 000000B7 00                 
    79                                  
    80                                  
    81                                  ;--------------------
    82                                  ; - Place every 2 bytes.
    83                                  ;--------------------
    84                                  ALIGN 2, db 0
    85                                  BOOT:
    86 000000B8 0000                    .DRIVE:   dw 0            ; drive number.
    87                                  
    88                                  ;--------------------
    89                                  ; - Declaration Module.
    90                                  ;--------------------
    91                                  %include "../modules/real_mode/putc.asm"
     1                              <1> putc:
     2                              <1>     ;---------------------
     3                              <1>     ; Create Stack Frame.
     4                              <1>     ;---------------------
     5 000000BA 55                  <1>     push bp          ; push to stack base pointer register.
     6 000000BB 89E5                <1>     mov  bp, sp      ; bp = sp. set top stack.
     7                              <1> 
     8                              <1>     ;---------------------
     9                              <1>     ; Saving Register.
    10                              <1>     ;---------------------
    11 000000BD 50                  <1>     push ax         ; ax (ah, al)
    12 000000BE 53                  <1>     push bx         ; bx
    13 000000BF 56                  <1>     push si         ; si
    14                              <1> 
    15                              <1>     ;---------------------
    16                              <1>     ; Get func argument.
    17                              <1>     ;---------------------
    18 000000C0 8B7604              <1>     mov si, [bp + 4]
    19                              <1> 
    20                              <1>     ;---------------------
    21                              <1>     ; Starting put process.
    22                              <1>     ;---------------------
    23 000000C3 B40E                <1>     mov ah, 0x0E    ; show Character output.
    24 000000C5 BB0000              <1>     mov bx, 0x0000  ; set page number & text color to 0
    25 000000C8 FC                  <1>     cld             ; DF = 0.
    26                              <1> 
    27                              <1> .10L:               ; do
    28                              <1>                     ; {
    29 000000C9 AC                  <1>     lodsb           ; AL = *SI++.
    30                              <1>                     ;
    31 000000CA 3C00                <1>     cmp al, 0       ; if(0 == AL)
    32 000000CC 7404                <1>     je .10E         ; break
    33                              <1>                     ;
    34 000000CE CD10                <1>     int 0x10        ; Int10(0x0E, AL); prrint char.
    35 000000D0 EBF7                <1>     jmp .10L        ;
    36                              <1> .10E:               ; while(1)
    37                              <1> 
    38                              <1>     ;---------------------
    39                              <1>     ; return Register.
    40                              <1>     ;---------------------
    41 000000D2 5E                  <1>     pop si
    42 000000D3 5B                  <1>     pop bx
    43 000000D4 58                  <1>     pop ax
    44                              <1> 
    45                              <1>     ;---------------------
    46                              <1>     ; reset Stack frame.
    47                              <1>     ;---------------------
    48 000000D5 89EC                <1>     mov sp, bp
    49 000000D7 5D                  <1>     pop bp
    50 000000D8 C3                  <1>     ret
    92                                  %include "../modules/real_mode/reboot.asm"
     1                              <1> reboot:
     2                              <1>     ;; Show Message.
     3 000000D9 68[F500]E8DBFF83C4- <1>     cdecl putc, .s0             ; Show Rebooting Message.
     3 000000E1 02                  <1>
     4                              <1> 
     5                              <1>     ;; Waiting for keyboard.
     6                              <1> .10L:                           ; do
     7                              <1>                                 ; {
     8 000000E2 B410                <1>     mov ah, 0x10                ; // Wating for input keyboard.
     9 000000E4 CD16                <1>     int 0x16                    ; // AL = BIOS(0x16, 0x10)
    10                              <1>                                 ;
    11 000000E6 3C00                <1>     cmp al, ''                  ; ZF == AL == '';
    12 000000E8 75F8                <1>     jne .10L                    ; } while(ZF)
    13                              <1> 
    14                              <1>     ;; Return Space.
    15 000000EA 68[1301]E8CAFF83C4- <1>     cdecl putc, .s1
    15 000000F2 02                  <1>
    16                              <1> 
    17                              <1>     ;; Reboot.
    18 000000F3 CD19                <1>     int 0x19                    ; BIOS(0x19); reboot()
    19                              <1> 
    20                              <1>     ;; Character Data.
    21                              <1>     ;; .s0 is character value.
    22                              <1>     ;; .s1 is new line.
    23 000000F5 0A0D50757368205350- <1> .s0 db 0x0A, 0x0D, "Push SPACE key to reboot...", 0
    23 000000FE 414345206B65792074- <1>
    23 00000107 6F207265626F6F742E- <1>
    23 00000110 2E2E00              <1>
    24 00000113 0A0D0A0D00          <1> .s1 db 0x0A, 0x0D, 0x0A, 0x0D, 0
    93                                  
    94                                  ;--------------------
    95                                  ; - Boot Flag.
    96                                  ; - Maybe Reserve the first 512 bytes.
    97                                  ; - Write 0x55 and 0xAA to 510bytes.
    98                                  ;--------------------
    99 00000118 00<rept>                times 510 - ($ - $$) db 0x00
   100 000001FE 55AA                    db    0x55, 0xAA
   101                                  
   102                                  stage_2:
   103                                      ;---------------------
   104                                      ;- second stage.
   105                                      ;---------------------
   106 00000200 68[0B02]E8B4FE83C4-         cdecl putc, .s0             ; putc(.s0)
   106 00000208 02                 
   107                                  
   108 00000209 EBFE                        jmp $
   109                                  
   110 0000020B 326E64207374616765-     .s0 db "2nd stage...", 0x0A, 0x0D, 0
   110 00000214 2E2E2E0A0D00       
   111                                      ;---------------------
   112                                      ; - second stage.
   113                                      ; - configuration boot program size.
   114                                      ;---------------------
   115 0000021A 00<rept>                    times(1024 * 8) - ($ - $$) db 0 ; 8K byte
