     1                                  ;---------------------
     2                                  ; - Configration Start to Boot Program Address.
     3                                  ;---------------------
     4                                  BOOT_LOAD equ 0x7c00    ; load to start boot program address.
     5                                  ORG       BOOT_LOAD     ; instruction load address to assembler.
     6                                  
     7                                  ;---------------------
     8                                  ; - Declaration Macro.
     9                                  ;---------------------
    10                                  %include "../include/macro.asm"
     1                              <1> %macro cdecl 1-*.nolist
     2                              <1> 
     3                              <1>     %rep %0 - 1
     4                              <1>         push %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1>     %rotate -1
     8                              <1> 
     9                              <1>         call %1
    10                              <1> 
    11                              <1>     %if 1 < %0
    12                              <1>         add sp, (__BITS__ >> 3) * (%0-1)
    13                              <1>     %endif
    14                              <1> 
    15                              <1> %endmacro
    11                                  
    12                                  entry:
    13                                      ;---------------------
    14                                      ; - BPB(BIOS Parameter Block).
    15                                      ; - First calling to ipl label.
    16                                      ; - BIOS Needs Information.
    17                                      ; - 0x90 set to 90bytes.
    18                                      ; - NOP(do no something).
    19                                      ;---------------------
    20 00000000 EB58                        jmp   ipl
    21 00000002 90<rept>                    times 90 - ($ - $$) db 0x90
    22                                  
    23                                  ipl:
    24 0000005A FA                          cli                 ; disable interrupt.
    25                                  
    26                                      ;------------------
    27                                      ; - Configuration Segment Register.
    28                                      ; - Segment is separate memory blocks.
    29                                      ; - Initialize Register.
    30                                      ;-------------------
    31 0000005B B80000                      mov ax, 0x0000      ; AX = 0x0000;
    32                                  
    33 0000005E 8ED8                        mov ds, ax          ; DS = 0x0000;
    34 00000060 8EC0                        mov es, ax          ; ES = 0x0000;
    35 00000062 8ED0                        mov ss, ax          ; SS = 0x0000;
    36                                  
    37                                      ;---------------------
    38                                      ; - Stack the boot program start position on the stack pointer.
    39                                      ;---------------------
    40 00000064 BC007C                      mov sp, BOOT_LOAD    ; SP = 0x7c00;
    41                                  
    42 00000067 FB                          sti                 ; enable interrupt.
    43                                  
    44                                      ;---------------------
    45                                      ; - Saving Boot Drive.
    46                                      ; - dl register is I/O register.
    47                                      ;---------------------
    48 00000068 8816[9600]                  mov [BOOT.DRIVE], dl
    49                                  
    50                                      ;--------------------
    51                                      ; - Call putc function, argument is '.s0'.
    52                                      ; - Call reboot function, nothing argument.
    53                                      ;--------------------
    54 0000006C 68[8000]E8260083C4-         cdecl putc, .s0
    54 00000074 02                 
    55                                  
    56 00000075 68[8D00]E83C0083C4-         cdecl reboot, .s1
    56 0000007D 02                 
    57                                  
    58                                      ;--------------------
    59                                      ; - Terminate imp Proccess;
    60                                      ;--------------------
    61 0000007E EBFE                        jmp $               ; Infinite loop.
    62                                  
    63                                  ;--------------------
    64                                  ; - 0x0A is LF(Line Feed).
    65                                  ; - 0x0D is CR(Caridge Return).
    66                                  ;--------------------
    67 00000080 426F6F74696E672E2E-     .s0 db "Booting...", 0x0A, 0x0D, 0
    67 00000089 2E0A0D00           
    68 0000008D 61616161610A0D00        .s1 db "aaaaa",   0x0A, 0x0D, 0
    69                                  
    70                                  ;--------------------
    71                                  ; - Place every 2 bytes.
    72                                  ;--------------------
    73 00000095 00                      ALIGN 2, db 0
    74                                  BOOT:
    75 00000096 0000                    .DRIVE:   dw 0            ; drive number.
    76                                  
    77                                  ;--------------------
    78                                  ; - Declaration Module.
    79                                  ;--------------------
    80                                  %include "../modules/real_mode/putc.asm"
     1                              <1> putc:
     2                              <1>     ;---------------------
     3                              <1>     ; Create Stack Frame.
     4                              <1>     ;---------------------
     5 00000098 55                  <1>     push bp          ; push to stack base pointer register.
     6 00000099 89E5                <1>     mov  bp, sp      ; bp = sp. set top stack.
     7                              <1> 
     8                              <1>     ;---------------------
     9                              <1>     ; Saving Register.
    10                              <1>     ;---------------------
    11 0000009B 50                  <1>     push ax         ; ax (ah, al)
    12 0000009C 53                  <1>     push bx         ; bx
    13 0000009D 56                  <1>     push si         ; si
    14                              <1> 
    15                              <1>     ;---------------------
    16                              <1>     ; Get func argument.
    17                              <1>     ;---------------------
    18 0000009E 8B7604              <1>     mov si, [bp + 4]
    19                              <1> 
    20                              <1>     ;---------------------
    21                              <1>     ; Starting put process.
    22                              <1>     ;---------------------
    23 000000A1 B40E                <1>     mov ah, 0x0E    ; show Character output.
    24 000000A3 BB0000              <1>     mov bx, 0x0000  ; set page number & text color to 0
    25 000000A6 FC                  <1>     cld             ; DF = 0.
    26                              <1> 
    27                              <1> .10L:               ; do
    28                              <1>                     ; {
    29 000000A7 AC                  <1>     lodsb           ; AL = *SI++.
    30                              <1>                     ;
    31 000000A8 3C00                <1>     cmp al, 0       ; if(0 == AL)
    32 000000AA 7404                <1>     je .10E         ; break
    33                              <1>                     ;
    34 000000AC CD10                <1>     int 0x10        ; Int10(0x0E, AL); prrint char.
    35 000000AE EBF7                <1>     jmp .10L        ;
    36                              <1> .10E:               ; while(1)
    37                              <1> 
    38                              <1>     ;---------------------
    39                              <1>     ; return Register.
    40                              <1>     ;---------------------
    41 000000B0 5E                  <1>     pop si
    42 000000B1 5B                  <1>     pop bx
    43 000000B2 58                  <1>     pop ax
    44                              <1> 
    45                              <1>     ;---------------------
    46                              <1>     ; reset Stack frame.
    47                              <1>     ;---------------------
    48 000000B3 89EC                <1>     mov sp, bp
    49 000000B5 5D                  <1>     pop bp
    50 000000B6 C3                  <1>     ret
    81                                  %include "../modules/real_mode/reboot.asm"
     1                              <1> reboot:
     2                              <1>     ;; Show Message.
     3 000000B7 68[D300]E8DBFF83C4- <1>     cdecl putc, .s0             ; Show Rebooting Message.
     3 000000BF 02                  <1>
     4                              <1> 
     5                              <1>     ;; Waiting for keyboard.
     6                              <1> .10L:                           ; do
     7                              <1>                                 ; {
     8 000000C0 B410                <1>     mov ah, 0x10                ; // Wating for input keyboard.
     9 000000C2 CD16                <1>     int 0x16                    ; // AL = BIOS(0x16, 0x10)
    10                              <1>                                 ;
    11 000000C4 3C00                <1>     cmp al, ''                  ; ZF == AL == '';
    12 000000C6 75F8                <1>     jne .10L                    ; } while(ZF)
    13                              <1> 
    14                              <1>     ;; Return Space.
    15 000000C8 68[F100]E8CAFF83C4- <1>     cdecl putc, .s1
    15 000000D0 02                  <1>
    16                              <1> 
    17                              <1>     ;; Reboot.
    18 000000D1 CD19                <1>     int 0x19                    ; BIOS(0x19); reboot()
    19                              <1> 
    20                              <1>     ;; Character Data.
    21 000000D3 0A0D50757368205350- <1> .s0 db 0x0A, 0x0D, "Push SPACE key to reboot...", 0
    21 000000DC 414345206B65792074- <1>
    21 000000E5 6F207265626F6F742E- <1>
    21 000000EE 2E2E00              <1>
    22 000000F1 0A0D0A0D00          <1> .s1 db 0x0A, 0x0D, 0x0A, 0x0D, 0
    82                                  
    83                                  ;--------------------
    84                                  ; - Boot Flag.
    85                                  ; - Maybe Reserve the first 512 bytes.
    86                                  ; - Write 0x55 and 0xAA to 510bytes.
    87                                  ;--------------------
    88 000000F6 00<rept>                times 510 - ($ - $$) db 0x00
    89 000001FE 55AA                    db    0x55, 0xAA
